---
title: 'Deploy Mezzanine to Ubuntu 14 server on DigitalOcean with Fabric'
date: '2016-03-14 23:38:59'
tags: ['python django mezzanine']
draft: false
summary: ''
images: []
---

<div align="center"><img id="img811" class="aligncenter size-medium sq_image" title="python django mezzanine" src="https://softwaresurvivor.com/wp-content/uploads/2017/11/django_badge.sh-600x600.png" alt="python django mezzanine" width="500"></div>
This guide will hopefully be useful to you in deploying your&nbsp;<a title="Mezzaine" href="http://mezzanine.jupo.org/" target="_blank" rel="noopener"><strong>Mezzanine</strong></a>&nbsp;4 application and&nbsp;<a href="https://www.djangoproject.com/" target="_blank" rel="noopener"><strong>Django</strong> 1.9</a>&nbsp;to&nbsp;a Ubuntu&nbsp;14 cloud server on&nbsp;<a href="https://www.digitalocean.com/github-students/?utm_medium=partnerships&amp;utm_source=github&amp;utm_campaign=studentdevpack" target="_blank" rel="noopener">DigitalOcean</a>&nbsp;with&nbsp;<a title="Nginx" href="https://www.nginx.com/resources/wiki/" target="_blank" rel="noopener">Nginx</a>&nbsp;and a&nbsp;<a href="http://www.postgresql.org/" target="_blank" rel="noopener">Postgres</a>&nbsp;database. Quite a mouthful.&nbsp;We will be using Fabric to install and deploy the application.

<strong>Mezzanine</strong>, a promising open sourced content&nbsp;management&nbsp;system&nbsp;built on top the popular <strong>Python</strong> Web framework, Django. Knowledge of <strong>Python</strong> and <strong>Django</strong> is not really&nbsp;necessary but would be extremely helpful if you decide to extend&nbsp;Mezzanine&nbsp;with your own custom application or feature(s).

Now, let the fun begin.

<strong>*If I make any mistakes. Let me know. Can't be having false or bad advice&nbsp;on the interwebs.. or can we?&nbsp;</strong>

Ideally, we first set up our development environment on your local computer, then deploy to the DigitalOcean server as you want to treat it as a&nbsp;full on a production&nbsp;server. However, we are going to work&nbsp;backward&nbsp;by installing the default application on DigitalOcean, pushing it to a git repo that you can then pull to your local computer. If you have a Mezzanine instance already, this guide will still be useful.

Pretend there are thousands of users at the public end, just waiting to see your server crash and burn. To avoid any embarrassment, we must make our changes to&nbsp;our local copy, test, push to a&nbsp;repository, ssh into our production server, pull, deploy, and test again. Sure, we can automate some tests, but that is a topic for another day. Before we continue, we must create accounts&nbsp;to&nbsp;the services we will be using. If you are a student with a .edu email address,&nbsp;hopefully&nbsp;the&nbsp;<a title="GitHub Student Developer Pack" href="https://education.github.com/pack/offers" target="_blank" rel="noopener">GitHub Student Developer Pack</a>&nbsp;is still available.&nbsp;Signup&nbsp;for a&nbsp;<a href="https://www.digitalocean.com/github-students/?utm_medium=partnerships&amp;utm_source=github&amp;utm_campaign=studentdevpack" target="_blank" rel="noopener">DigitalOcean</a>&nbsp;and a&nbsp;<a title="Github" href="https://github.com/" target="_blank" rel="noopener">Github</a>&nbsp;account.
<h2>Setting up&nbsp;your Ubuntu droplet</h2>
DigitalOcean allows you to create a Django droplet in one click, but for the sake of education and having total control of what is installed on the server, create&nbsp;a Ubuntu&nbsp;14.XX x64 instance and give it a hostname. The smallest instance of 512MB/1CPU is enough to get started.&nbsp;Take note of your IP and ssh into your Ubuntu droplet as root. You will be prompted to create a new password.
<p class="p1"><code><span class="s1">$ssh root@YOUR.DROPLET.IP</span></code></p>
The first thing we should do before we continue&nbsp;is update&nbsp;the base Ubuntu software.

<code>$apt-get update</code>

Next&nbsp;we will install important packages that are used&nbsp;by most open sourced projects that need to compile in order to work. You can view the installed&nbsp;components at&nbsp;the&nbsp;<a title="Ubuntu Package wiki " href="http://packages.ubuntu.com/precise/build-essential" target="_blank" rel="noopener">Ubuntu Package wiki</a>.
<p class="p1"><code><span class="s1">$apt-get install build-essential</span></code></p>
Python 2.7 is already installed on the server, but we still will need to install some important packages that a lot of Python applications depend on to run.
<p class="p1"><code><span class="s1">$apt-get install python-setuptools</span></code></p>
<p class="p1"><code><span class="s1"> python-dev&nbsp;python2.7-dev</span></code></p>
<p class="p1"><code><span class="s1"> python-software-properties&nbsp;</span></code></p>
<p class="p1"><code><span class="s1"> libpq-dev python-pip</span></code></p>
<p class="p1"><code><span class="s1">$apt-get install git libtiff4-dev</span></code></p>
<p class="p1"><code><span class="s1"> libjpeg8-dev&nbsp;zlib1g-dev</span></code></p>
<p class="p1"><code><span class="s1"> libfreetype6-dev liblcms2-dev&nbsp;</span></code></p>
<p class="p1"><code><span class="s1"> libwebp-dev tcl8.5-dev tk8.5-dev</span></code></p>
That was a lot of stuff to install and we are still not done. If you noticed above, we installed&nbsp;<a title="PIP" href="https://pip.pypa.io/en/stable/" target="_blank" rel="noopener">PIP</a>, a useful package management system that we will use to install all our Python applications. We have one more package&nbsp;to install before we get started with&nbsp;Mezzaine.&nbsp;<a title="Virtualenv" href="https://virtualenv.pypa.io/en/latest/" target="_blank" rel="noopener">Virtualenv</a>&nbsp;is an extremely powerful tool that allows you to create a sandbox python environment that is completely separate from the server. For example, say you want to upgrade to Python 3 without having to install it on the actual server. You can just install it in this isolated virtual environment and your mind will be at ease&nbsp;if something went wrong since you can just delete or start a new environment with no impact on the actual server. To install&nbsp;<a title="Virtualenv" href="https://virtualenv.pypa.io/en/latest/" target="_blank" rel="noopener">Virtualenv</a>, we use PIP. We will also install future and fabric, but I'll get to those later.

<code>$pip install virtualenv future fabric&nbsp;mezzanine</code>

Now, you may have noticed we have been installing all these packages as the root user of the server. Generally, you never want to use root to install packages on the server because it defeats the security model in place in most Linux distributions. Check your&nbsp;privileges! Before we continue to the gravy of this tutorial.&nbsp;Let us&nbsp;create an account with&nbsp;sudo&nbsp;privileges to log into.

<code>$adduser admin</code>

<code>$sudo adduser admin sudo</code>

<code>$exit</code>
<p class="p1"><code>$ssh admin@YOUR.DROPLET.IP</code></p>
&nbsp;Time for business!
<h2>Installing&nbsp;Mezzanine</h2>
You should be logged in as the admin user we created in the previous section. I mean.. you can continue as root, but it's a big NO-NO. Seriously.&nbsp;Lets&nbsp;create our virtual environment for your site, which I&nbsp;will call mezzanineEnv

<code>$virtualenv mezzanineEnv</code>

A folder will be created in the current directory that we need to dive into to activate the virtual environment.

<code>$ls</code>

<code>$cd mezzanineEnv</code>

<code>$source bin/activate</code>

When you run the previous&nbsp;command you will see the folder name in parenthesis "(FOLDER_NAME)" on the left side of your terminal, indicating you are in the virtual&nbsp;environment. Our environment is now ready and we can install Mezzanine 4.1.0.&nbsp;Luckily, we can use PIP. At the time of this writing, mezzanine will automatically install all of&nbsp;it's&nbsp;dependencies. This includes&nbsp;<a title="Pillow" href="https://github.com/python-pillow/Pillow" target="_blank" rel="noopener">Pillow</a>, an important Python imaging library and of course, Django (1.9.4 at time of writing).

<code>$pip install mezzanine</code>

Awesome. Now we are ready to create our mezzanine&nbsp;application and our database. Make sure you install the initial demo pages if you are starting from&nbsp;scratch. We can delete the pages later if need be, but it is nice to have something without any additional effort. By default, Django will use SQLite as the database, which we will keep for this initial run. When we are ready to deploy, we will set up Postgres. After you create the database, run the&nbsp;built-in&nbsp;Django&nbsp;server command to see your Mezzanine instance. Yes, the 0.0.0.0 are needed. The command will automatically detect your IP, so when you&nbsp;get&nbsp;<strong>"<span class="s1">Starting development server at http://0.0.0.0:8000/"&nbsp;</span></strong><span class="s1">after you run the&nbsp;runserver&nbsp;command, don't be alarmed. You can visit the demo&nbsp;mezzanine&nbsp;app at&nbsp;YOUR.DROPLET.IP:8000. If you are not that&nbsp;familar&nbsp;with Django,&nbsp;the&nbsp;manage.py file is the gateway to all the important Django framework commands that will help you with your application.&nbsp;</span>

<code>$mezzanine-project&nbsp;mezz_app</code>

<code>$cd mezz_app</code>

<code>$python manage.py createdb</code>

<code>$python manage.py runserver 0.0.0.0:8000&nbsp;</code>
<h2>Deploying your Mezzanine application</h2>
Your users are waiting and we want a full-fledged&nbsp;server to handle the traffic and&nbsp;a&nbsp;production-ready&nbsp;database. The Mezzanine website does have a&nbsp;<a href="http://mezzanine.jupo.org/docs/deployment.html" target="_blank" rel="noopener">deployment wiki</a>, which is really helpful, but a bit incomplete. I ran into a few issues when I first deployed this&nbsp;site and prompted me to write this post. Documentation is king, even though we all hate to write it.&nbsp;Also&nbsp;social validation is a good thing. I will summarize some&nbsp;portions from&nbsp;that wiki page, so I&nbsp;recommend&nbsp;reading it at some point if you are hungry for more&nbsp;details.

To properly deploy Mezzanine, we need a public facing&nbsp;web server, an internal HTTP application server, a database server, a memory caching server, and a process control monitor.&nbsp;You may be cracking your knuckles to prepare yourself for the onslaught of Linux commands we are going to type to install all these servers and tools. Of&nbsp;course, it would be a pain! Imagine if we mess up the installation of one or more of these tools, forcing us to search the internet for hours for the solution until we find ourselves tempted to flip our desks. If only someone can build a script to install all this stuff for us to save us from that misery. Fortunately, there is a Python solution called&nbsp;<a title="Fabric" href="http://www.fabfile.org/" target="_blank" rel="noopener">Fabric</a>&nbsp;that enables us to automatically deploy these applications and better yet, Mezzanine&nbsp;is already configured for Fabric. If you check out the directory of our application you will notice a&nbsp;<strong><span class="s1">fabfile.py&nbsp;</span></strong><span class="s1">file and a&nbsp;<strong>deploy</strong>&nbsp;folder. This&nbsp;fabfile&nbsp;script will import important configurations from the deploy folder to set up our production server. Here is a breakdown of what will be installed.&nbsp;</span>
<ul class="simple">
 	<li><a class="reference external" href="http://nginx.org/">NGINX</a>&nbsp;- public facing web server</li>
 	<li><a class="reference external" href="http://gunicorn.org/">gunicorn</a>&nbsp;- internal HTTP application server</li>
 	<li><a class="reference external" href="http://postgresql.org/">PostgreSQL</a>&nbsp;- database server</li>
 	<li><a class="reference external" href="http://memcached.org/">memcached</a>&nbsp;- in-memory caching server</li>
 	<li><a class="reference external" href="http://supervisord.org/">supervisord</a>&nbsp;- process control and monitor</li>
 	<li><a class="reference external" href="https://pypi.python.org/pypi/virtualenv">virtualenv</a>&nbsp;- isolated Python environments for each project</li>
 	<li><a class="reference external" href="http://git-scm.com/">git</a>&nbsp;or&nbsp;<a class="reference external" href="http://mercurial.selenic.com/">mercurial</a>&nbsp;- version control systems (optional)</li>
</ul>
Change directories to&nbsp;<strong>"<span class="s1">~/mezzanineEnv/mezz_app/mezz_app</span>"&nbsp;</strong>and you will find a&nbsp;<strong>local_setting.py&nbsp;</strong>file and&nbsp;a<strong>&nbsp;settings.py</strong>&nbsp;file. We used settings.py to run the application locally, and local_settings.py will be used by Fabric to define the configurations that are needed&nbsp;for the production environment. Open up local_settings.py with your favorite terminal text editor (nano and vim are already installed).

Let's fill in our Postgres database settings in the DATABASES dictionary.
<pre className="p1"><span className="s1">DATABASES = {{
       "ENGINE" : "django.db.backends.postgresql_psycopg2",
       "NAME" : "mezz_app_live",
       "USER" : "admin", 
       "PASSWORD": "YOUR_DB_PASSWORD",
       ....
}}</span></pre>
Next, we have to set up our deploy settings at the end of local_settings.py. If you have a domain purchased, you will have to place it here. If not, you can use your&nbsp;digitial&nbsp;ocean IP for now.
<pre class="p1"><span class="s1">ALLOWED_HOSTS = [</span><span class="s2"><strong>"YOUR_IP_OR_PUBLIC_DOMAIN"</strong></span><span class="s1">]</span></pre>
Finally, we define the FABRIC dictionary with our server's information. We will be using the same admin user we created, but you can define a new user here to deploy the application, but you will have to run '<strong>fab secure</strong>' to create that user before installing all components.
<pre>FABRIC = {
 "DEPLOY_TOOL": "", # Deploy with "git", "hg", or "rsync"
 "SSH_USER": "admin", # VPS SSH username
 "HOSTS": ["<strong>YOUR_DIGITIAL_OCEAN_IP</strong>"], # The IP address of your VPS
 "DOMAINS": ALLOWED_HOSTS, # Edit domains in ALLOWED_HOSTS
 "REQUIREMENTS_PATH": "requirements.txt", # Project's pip requirements
 "LOCALE": "en_US.UTF-8", # Should end with ".UTF-8"
 "DB_PASS": "YOUR_DB_PASSWORD", # Live database password
 "ADMIN_PASS": "YOUR_PASSWORD", # Live admin user password
 "SECRET_KEY": SECRET_KEY,
 "NEVERCACHE_KEY": NEVERCACHE_KEY,
}</pre>
Save the file and&nbsp;deactive&nbsp;the&nbsp;virtualEnv.

<code>$deactivate</code>

Make sure you are in the directory where the&nbsp;<strong>'fabfile.py'</strong>&nbsp;exists. When I was making this tutorial I ran into a little issue when I was deploying the application. Django 1.9 has deprecated the&nbsp;syncdb&nbsp;command because of the migration system. Our fab file still contains this command and if we were to try to install as-is, it would fail. Open up the fab file and comment out the&nbsp;syncdb&nbsp;command.
<pre> with project():
    manage("collectstatic -v 0 --noinput")
  <strong> #manage("syncdb --noinput")</strong>
    manage("migrate ")
 for name in get_templates():
    ....</pre>
Save it and&nbsp;finally, we can go ahead and deploy Mezzanine. When we run the fabric command to deploy the application, you will be asked several times for the user password and in some&nbsp;cases, you may even notice we are SSHing into the server we are on. Weird. But not weird. In this&nbsp;case, it is, but later, if you want to deploy your application from your local computer without having to ssh into the server, you will be able to. Ok, enough talk. Let's do this.

<code>fab all</code>

Bam!&nbsp;Hopefully, you didn't get any errors and if you go to your server's IP address you will see the Ngnix welcome page. Wait. Where is our application!? Unfortunately, fab installed our application assuming we have an SSL certificate. We need to disable that check for now, but you should installed an SSL certificate after you have a domain name. Once you have one,&nbsp;try out&nbsp;<a title="Lets Encrypt" href="https://letsencrypt.org/" target="_blank" rel="noopener">Let's Encrypt</a>&nbsp;to get a free SSL certificate.

Open up the application's Ngnix configuration and comment out the following lines in bold by adding a '#' before the text. The config file is located at
<pre>&nbsp;<code><span class="s1">$nano /etc/nginx/sites-enabled/mezz_app.conf</span></code></pre>
<pre> listen 80;
 <strong>#listen 433 ssl;</strong>
  .....
<strong> #ssl_certificate conf/mezz_app.crt;</strong>
<strong> #ssl_certificate_key conf/mezz_app.key;</strong>
<strong> #ssl_session_cache shared:SSL:10m;</strong>
<strong> #ssl_session_timeout 10m;</strong>
<strong> #ssl_ciphers ...:ECDHE-RSA-AES256-GCM-S$</strong>
<strong> #ssl_prefer_server_ciphers on;</strong></pre>
Phew. Save it and restart the Ngnix server
<p class="p1"><code><span class="s1">sudo service nginx restart</span></code></p>
&nbsp;If all went ok, you should now see the Mezzanine application at your server's IP address. In the next session, we will set up our Git repo and go through the updating and re-deployment process. For now, happy coding! :)

&nbsp;

&nbsp;